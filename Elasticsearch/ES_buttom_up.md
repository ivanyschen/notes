# Elaticsearch from the Buttom Up
- Important Data Structure: inverted index. An index term is the unit of search.
- Keeping the data structures small and compact means sacrificing the possibility to efficiently update them. In fact, Lucene does not update them at all: the index files Lucene write are **immutable**.
- When deleting a document, the document is marked in a special deletion file. *The index structures themselves are not updated.*
- When new documents are added (perhaps via an update), the index changes are first *buffered in memory*. Eventually, the index files in their entirety, are *flushed* to disk.
- A Lucene index is made up of one or more immutable *index segments*, which essentially is a "mini-index". When you do a search, Lucene does the search on **every** segment, filters out any deletions, and merges the results from all the segments. To keep the number of segments manageable, Lucene occasionally merges segments according to some merge policy as new segments are added. When segments are merged, documents marked as deleted are finally discarded. This is why adding more documents can actually result in a smaller index size: it can trigger a merge.
- As new segments are created (either due to a flush or a merge), they also *cause certain caches to be invalidated*, which can negatively impact search performance. Caches like the *field* and *filter* caches are **per segment**. Elasticsearch has a warmer-API5, so the necessary caches can be "warmed" before the new segment is made available for search.
- The most common cause for flushes with Elasticsearch is probably the continuous index refreshing, which by default happens once every second. As new segments are flushed, they become available for searching, enabling (near) real-time search. While a flush is not as expensive as a commit (as it does not need to wait for a confirmed write), it does cause a new segment to be created, invalidating some caches, and possibly triggering a merge.
- When indexing throughput is important, e.g. when batch (re-)indexing, it is not very productive to spend a lot of time flushing and merging small segments. **Therefore, tt is usually a good idea to temporarily increase the `refresh_interval` setting, or even disable automatic refreshing altogether. One can always refresh manually, and/or when indexing is done.**
- An Elasticsearch index is made up of one or more *shards*, which can have zero or more replicas. These are all individual *Lucene indexes*. That is, *an Elasticsearch index is made up of many Lucene indexes, which in turn is made up of index segments.*
- A "shard" is the basic scaling unit for Elasticsearch. As documents are added to the index, it is routed to a shard. By default, this is done in a round-robin fashion, based on the hash of the document's id. *However, the number of shards is specified at **index creation time**, and cannot be changed later on.*

## Credits:
- https://www.elastic.co/blog/found-elasticsearch-from-the-bottom-up
